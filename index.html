<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Split Bill Simple</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
    label { display: block; margin-top: 0.5rem; }
    input[type=number] { width: 100px; }
    table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    button { margin: 0 3px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>Split Bill - Tariska, Delano, Lika, Husin</h2>

  <form id="addForm">
    <label>
      Description:
      <input type="text" id="desc" required />
    </label>
    <label>
      Payer:
      <select id="payer" required>
        <option value="Tariska">Tariska</option>
        <option value="Delano">Delano</option>
        <option value="Lika">Lika</option>
        <option value="Husin">Husin</option>
      </select>
    </label>
    <label>
      Amount (Rp):
      <input type="number" id="amount" min="1" required />
    </label>
    <label>
      <input type="checkbox" id="equalSplit" checked /> Split equally among all?
    </label>
    <div id="sharesInputs" style="margin-top:0.5rem; display:none;">
      <label>Tariska owes (Rp): <input type="number" id="shareTariska" min="0" value="0" /></label>
      <label>Delano owes (Rp): <input type="number" id="shareDelano" min="0" value="0" /></label>
      <label>Lika owes (Rp): <input type="number" id="shareLika" min="0" value="0" /></label>
      <label>Husin owes (Rp): <input type="number" id="shareHusin" min="0" value="0" /></label>
      <div class="error" id="sharesError"></div>
    </div>
    <button type="submit">Add Transaction</button>
  </form>

  <h3>Transactions</h3>
  <table id="txTable">
    <thead>
      <tr>
        <th>Description</th><th>Payer</th><th>Amount (Rp)</th><th>Shares (Rp)</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="summary" style="margin-top:2rem;"></div>

  <script>
    const people = ["Tariska", "Delano", "Lika", "Husin"];

    let transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
    let editingIndex = -1;

    const addForm = document.getElementById("addForm");
    const descInput = document.getElementById("desc");
    const payerInput = document.getElementById("payer");
    const amountInput = document.getElementById("amount");
    const equalSplitInput = document.getElementById("equalSplit");
    const sharesInputsDiv = document.getElementById("sharesInputs");
    const sharesErrorDiv = document.getElementById("sharesError");
    const txTableBody = document.querySelector("#txTable tbody");
    const summaryDiv = document.getElementById("summary");

    const shareInputs = {
      Tariska: document.getElementById("shareTariska"),
      Delano: document.getElementById("shareDelano"),
      Lika: document.getElementById("shareLika"),
      Husin: document.getElementById("shareHusin")
    };

    equalSplitInput.addEventListener("change", () => {
      if (equalSplitInput.checked) {
        sharesInputsDiv.style.display = "none";
        sharesErrorDiv.textContent = "";
      } else {
        sharesInputsDiv.style.display = "block";
      }
    });

    function saveTransactions() {
      localStorage.setItem("transactions", JSON.stringify(transactions));
    }

    function clearForm() {
      descInput.value = "";
      payerInput.value = people[0];
      amountInput.value = "";
      equalSplitInput.checked = true;
      sharesInputsDiv.style.display = "none";
      sharesErrorDiv.textContent = "";
      for (const p of people) {
        shareInputs[p].value = "0";
      }
      editingIndex = -1;
      addForm.querySelector("button").textContent = "Add Transaction";
    }

    function validateShares(amount) {
      if (equalSplitInput.checked) return true;

      let sumShares = 0;
      for (const p of people) {
        const val = Number(shareInputs[p].value);
        if (isNaN(val) || val < 0) {
          sharesErrorDiv.textContent = "Shares must be numbers â‰¥ 0.";
          return false;
        }
        sumShares += val;
      }
      if (sumShares !== amount) {
        sharesErrorDiv.textContent = `Sum of shares (Rp${sumShares.toLocaleString()}) must equal total amount (Rp${amount.toLocaleString()}).`;
        return false;
      }
      sharesErrorDiv.textContent = "";
      return true;
    }

    function renderTransactions() {
      txTableBody.innerHTML = "";
      transactions.forEach((tx, i) => {
        const sharesText = people.map(p => `${p}: Rp${(tx.shares[p] || 0).toLocaleString()}`).join(", ");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${tx.desc}</td>
          <td>${tx.payer}</td>
          <td>Rp${tx.amount.toLocaleString()}</td>
          <td>${sharesText}</td>
          <td>
            <button onclick="editTx(${i})">Edit</button>
            <button onclick="deleteTx(${i})">Delete</button>
          </td>
        `;
        txTableBody.appendChild(tr);
      });
    }

    function renderSummary() {
      summaryDiv.innerHTML = "<h3>Summary</h3>";

      // Calculate total paid per person and total owed per person
      const totalPaid = {};
      const totalOwed = {};

      people.forEach(p => {
        totalPaid[p] = 0;
        totalOwed[p] = 0;
      });

      transactions.forEach(tx => {
        totalPaid[tx.payer] += tx.amount;
        people.forEach(p => {
          if (tx.shares[p]) totalOwed[p] += tx.shares[p];
        });
      });

      const netBalance = {};
      people.forEach(p => {
        netBalance[p] = totalPaid[p] - totalOwed[p];
      });

      const debtors = [];
      const creditors = [];

      people.forEach(p => {
        if (netBalance[p] < 0) {
          debtors.push({ person: p, amount: -netBalance[p] });
        } else if (netBalance[p] > 0) {
          creditors.push({ person: p, amount: netBalance[p] });
        }
      });

      if (debtors.length === 0) {
        summaryDiv.innerHTML += "<div>All settled up!</div>";
        return;
      }

      debtors.forEach(debtor => {
        let amountLeft = debtor.amount;
        for (let i = 0; i < creditors.length; i++) {
          const creditor = creditors[i];
          if (creditor.amount === 0) continue;
          const owed = Math.min(amountLeft, creditor.amount);

          summaryDiv.innerHTML += `<div><strong>${debtor.person}</strong> owes <strong>${creditor.person}</strong>: Rp${owed.toLocaleString()}</div>`;

          amountLeft -= owed;
          creditor.amount -= owed;
          if (amountLeft <= 0) break;
        }
      });
    }

    // Expose functions to global for inline onclick handlers
    window.editTx = function(i) {
      const tx = transactions[i];
      descInput.value = tx.desc;
      payerInput.value = tx.payer;
      amountInput.value = tx.amount;
      editingIndex = i;

      const allEqualShares = people.every(p => {
        return tx.shares[p] === Math.round(tx.amount / people.length);
      });

      if (allEqualShares) {
        equalSplitInput.checked = true;
        sharesInputsDiv.style.display = "none";
      } else {
        equalSplitInput.checked = false;
        sharesInputsDiv.style.display = "block";
        people.forEach(p => {
          shareInputs[p].value = tx.shares[p] || 0;
        });
      }
      sharesErrorDiv.textContent = "";
      addForm.querySelector("button").textContent = "Update Transaction";
    };

    window.deleteTx = function(i) {
      if (confirm("Delete this transaction?")) {
        transactions.splice(i, 1);
        saveTransactions();
        renderTransactions();
        renderSummary();
        if (editingIndex === i) clearForm();
      }
    };

    addForm.addEventListener("submit", e => {
      e.preventDefault();

      const desc = descInput.value.trim();
      const payer = payerInput.value;
      const amount = Number(amountInput.value);

      if (!desc) {
        alert("Description is required");
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        alert("Amount must be a positive number");
        return;
      }

      if (!validateShares(amount)) {
        return;
      }

      let shares = {};
      if (equalSplitInput.checked) {
        // Equal split
        const shareVal = Math.round(amount / people.length);
        let remainder = amount - shareVal * people.length;
        people.forEach(p => (shares[p] = shareVal));
        // Distribute remainder
        for (let i = 0; i < remainder; i++) {
          shares[people[i]] += 1;
        }
      } else {
        people.forEach(p => {
          shares[p] = Number(shareInputs[p].value) || 0;
        });
      }

      if (editingIndex >= 0) {
        // Update existing
        transactions[editingIndex] = { desc, payer, amount, shares };
      } else {
        // Add new
        transactions.push({ desc, payer, amount, shares });
      }

      saveTransactions();
      renderTransactions();
      renderSummary();
      clearForm();
    });

    // Initial render
    renderTransactions();
    renderSummary();
  </script>
</body>
</html>
